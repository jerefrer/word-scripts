#!/usr/bin/env python3
from docx import Document
from anthropic import Anthropic, RateLimitError
import os, sys, time, json
from docx.shared import RGBColor

def get_context_blocks(doc):
    blocks = []
    current_block = []
    current_styles = []
    
    for para in doc.paragraphs:
        if "Translation" in para.style.name or para.style.name == "Heading 1":
            current_block.append(para.text)
            current_styles.append(para.style.name)
            # When block reaches ~10 paragraphs, save it and start new block
            if len(current_block) >= 10:
                blocks.append((current_block.copy(), current_styles.copy()))
                current_block = []
                current_styles = []
        elif current_block and not ("Translation" in para.style.name or para.style.name == "Heading 1"):
            continue
            
    if current_block:  # Don't forget remaining paragraphs
        blocks.append((current_block, current_styles))
    return blocks

def translate_with_retry(anthropic, text, max_retries=3, delay=2):
    for attempt in range(max_retries):
        try:
            print("\nSending text:")
            print("-------------------")
            print(text)
            print("-------------------")
            
            response = anthropic.messages.create(
                model="claude-3-sonnet-20240229",
                max_tokens=1000,
                messages=[{
                    "role": "user", 
                    "content": f"""Translate this English text to French, maintaining exact line breaks and structure:
{text}
Important:
- Return only the French translation, line by line
- Keep Sanskrit/Tibetan terms unchanged (e.g. Hūṃ)
- Do not modify mantras
- Keep exactly the same number of lines
- Use formal liturgical French"""
                }]
            )
            
            print("\nReceived translation:")
            print("-------------------")
            print(response.content[0].text)
            print("-------------------\n")
            
            return response
        except RateLimitError:
            if attempt < max_retries - 1:
                print(f"Rate limit hit, waiting {delay} seconds...")
                time.sleep(delay)
                delay *= 2
            else:
                raise
        except Exception as e:
            print(f"Error: {e}")
            raise

def save_progress(translations, output_file):
    with open(output_file, 'w') as f:
        json.dump(translations, f, ensure_ascii=False, indent=2)

def load_progress(progress_file):
    if os.path.exists(progress_file):
        with open(progress_file) as f:
            return json.load(f)
    return {}

def process_document(input_path, output_path):
    progress_file = f"{output_path}.progress.json"
    translations = load_progress(progress_file)
    
    anthropic = Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])
    doc = Document(input_path)
    blocks = get_context_blocks(doc)
    
    print(f"Found {len(blocks)} blocks to translate")
    
    for i, (block_texts, _) in enumerate(blocks, 1):
        context = "\n".join(block_texts)
        if context not in translations:
            print(f"Translating block {i}/{len(blocks)} ({len(block_texts)} lines)")
            response = translate_with_retry(anthropic, context)
            translations[context] = [line for line in response.content[0].text.split('\n') if line.strip()]
            save_progress(translations, progress_file)
            time.sleep(1.5)
        else:
            print(f"Skipping block {i}/{len(blocks)} (already translated)")

    print("Creating output document...")
    new_doc = Document()
    for s in doc.styles:
        if s.name not in new_doc.styles:
            try:
                new_doc.styles.add_style(s.name, s.type)
            except:
                pass

    for para in doc.paragraphs:
        new_doc.add_paragraph(para.text, para.style.name)
        if "Translation" in para.style.name or para.style.name == "Heading 1":
            style_name = f"{para.style.name} French"
            if style_name not in new_doc.styles:
                try:
                    french_style = new_doc.styles.add_style(style_name, 1)
                    french_style.base_style = new_doc.styles[para.style.name]
                    french_style.font.color.rgb = RGBColor(0, 0, 139)
                except:
                    pass
            
            for block_texts, _ in blocks:
                if para.text in block_texts:
                    idx = block_texts.index(para.text)
                    if idx < len(translations["\n".join(block_texts)]):
                        new_doc.add_paragraph(translations["\n".join(block_texts)][idx], style_name)
                    break
    
    new_doc.save(output_path)
    print(f"Document saved to {output_path}")

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python script.py input.docx output.docx")
        sys.exit(1)
    process_document(sys.argv[1], sys.argv[2])