#!/usr/bin/env python3

import os
import sys
import docx
import subprocess
from pathlib import Path
import argparse
import logging
import shutil

def setup_logging():
    """Configure logging settings"""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )

def check_antiword():
    """Check if antiword is installed"""
    return shutil.which('antiword') is not None

def extract_text_from_doc(file_path):
    """Extract text from .doc file using antiword"""
    try:
        if not check_antiword():
            logging.error("antiword is not installed. Please install it first.")
            logging.error("On macOS: brew install antiword")
            logging.error("On Linux: sudo apt-get install antiword  # or your distro's equivalent")
            return None
            
        result = subprocess.run(
            ['antiword', str(file_path)],
            capture_output=True,
            text=True,
            check=True
        )
        return result.stdout
    except subprocess.CalledProcessError as e:
        logging.error(f"Error processing .doc file {file_path}: {str(e)}")
        logging.error(f"antiword error output: {e.stderr}")
        return None
    except Exception as e:
        logging.error(f"Error processing .doc file {file_path}: {str(e)}")
        return None

def extract_text_from_docx(file_path):
    """Extract text from .docx file"""
    try:
        doc = docx.Document(file_path)
        full_text = []
        
        # Extract text from paragraphs
        for para in doc.paragraphs:
            if para.text.strip():  # Only add non-empty paragraphs
                full_text.append(para.text)
        
        # Extract text from tables
        for table in doc.tables:
            for row in table.rows:
                row_text = []
                for cell in row.cells:
                    if cell.text.strip():  # Only add non-empty cells
                        row_text.append(cell.text.strip())
                if row_text:  # Only add non-empty rows
                    full_text.append('\t'.join(row_text))
        
        return '\n'.join(full_text)
    except Exception as e:
        logging.error(f"Error processing file {file_path}: {str(e)}")
        return None

def save_text_file(text, output_path):
    """Save extracted text to a file"""
    try:
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(text)
        logging.info(f"Successfully created: {output_path}")
    except Exception as e:
        logging.error(f"Error saving text file {output_path}: {str(e)}")

def process_file(file_path):
    """Process a single Word file"""
    if not os.path.exists(file_path):
        logging.error(f"File not found: {file_path}")
        return False

    file_path = Path(file_path)
    output_path = file_path.with_suffix('.txt')
    
    if output_path.exists():
        logging.warning(f"Output file already exists, will overwrite: {output_path}")

    suffix = file_path.suffix.lower()
    if suffix == '.docx':
        text = extract_text_from_docx(file_path)
    elif suffix == '.doc':
        text = extract_text_from_doc(file_path)
    else:
        logging.error(f"Unsupported file format (only .doc and .docx supported): {file_path}")
        return False

    if text is not None:
        save_text_file(text, output_path)
        return True
    return False

def process_directory(directory_path):
    """Process all Word files in a directory"""
    if not os.path.exists(directory_path):
        logging.error(f"Directory not found: {directory_path}")
        return 0

    success_count = 0
    word_files = []
    
    # Collect all Word files in the directory
    for root, _, files in os.walk(directory_path):
        for file in files:
            if file.lower().endswith(('.doc', '.docx')):
                word_files.append(os.path.join(root, file))

    if not word_files:
        logging.warning(f"No Word files found in directory: {directory_path}")
        return 0

    total_files = len(word_files)
    logging.info(f"Found {total_files} Word files to process")

    # Process each Word file
    for i, file_path in enumerate(word_files, 1):
        logging.info(f"Processing file {i}/{total_files}: {file_path}")
        if process_file(file_path):
            success_count += 1

    return success_count

def main():
    """Main function to handle command line arguments and process files"""
    parser = argparse.ArgumentParser(
        description='Convert Word files (.doc and .docx) to text files.',
        epilog='Example: python word-to-txt myfile.docx OR python word-to-txt mydirectory'
    )
    parser.add_argument('path', help='Path to Word file or directory containing Word files')
    args = parser.parse_args()

    setup_logging()
    
    path = os.path.abspath(args.path)
    
    if os.path.isfile(path):
        success = process_file(path)
        sys.exit(0 if success else 1)
    elif os.path.isdir(path):
        success_count = process_directory(path)
        logging.info(f"Successfully converted {success_count} files")
        sys.exit(0 if success_count > 0 else 1)
    else:
        logging.error(f"Invalid path: {path}")
        sys.exit(1)

if __name__ == "__main__":
    main()