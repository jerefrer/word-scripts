#!/usr/bin/env python3
"""Ensure the 'Verse Phonetics' style uses the requested formatting across DOCX files."""

from __future__ import annotations

import argparse
import sys
from pathlib import Path
from typing import List, Sequence, Tuple

try:
    from docx import Document
    from docx.enum.style import WD_STYLE_TYPE
    from docx.enum.text import WD_LINE_SPACING
    from docx.shared import Pt
except ImportError:  # pragma: no cover - CLI ergonomics only
    print("Error: python-docx library not found.", file=sys.stderr)
    print("Install it with: pip install python-docx", file=sys.stderr)
    sys.exit(1)

DOCX_SUFFIX = ".docx"
TEMP_PREFIX = "~$"
STYLE_NAME = "Verse Phonetics"
LINE_SPACING_PT = None
FONT_SIZE_PT = 14


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Set 'Verse Phonetics' style 14pt Arial, standard line spacing, no left indent."
    )
    parser.add_argument(
        "paths",
        nargs="+",
        help="DOCX files or folders to scan (folders processed recursively).",
    )
    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="Show which files would change without saving them.",
    )
    return parser.parse_args()


def collect_docx_paths(paths: Sequence[str]) -> List[Path]:
    found: List[Path] = []
    seen = set()

    for raw_path in paths:
        path = Path(raw_path).expanduser()
        if not path.exists():
            print(f"Warning: {path} does not exist, skipping.", file=sys.stderr)
            continue

        if path.is_file():
            if _is_valid_docx(path) and path not in seen:
                found.append(path)
                seen.add(path)
            continue

        for docx_file in path.rglob(f"*{DOCX_SUFFIX}"):
            if _is_valid_docx(docx_file) and docx_file not in seen:
                found.append(docx_file)
                seen.add(docx_file)

    return sorted(found)


def _is_valid_docx(path: Path) -> bool:
    return (
        path.is_file()
        and path.suffix.lower() == DOCX_SUFFIX
        and not path.name.startswith(TEMP_PREFIX)
    )


def update_style_in_file(doc_path: Path, dry_run: bool) -> bool:
    document = Document(doc_path)
    style = _ensure_style(document)
    changed = _apply_formatting(style)

    if changed and not dry_run:
        document.save(doc_path)
    return changed


def _ensure_style(document: Document):
    try:
        return document.styles[STYLE_NAME]
    except KeyError:
        return document.styles.add_style(STYLE_NAME, WD_STYLE_TYPE.PARAGRAPH)


def _apply_formatting(style) -> bool:
    changed = False
    paragraph_format = style.paragraph_format

    if paragraph_format.line_spacing_rule != WD_LINE_SPACING.SINGLE:
        paragraph_format.line_spacing_rule = WD_LINE_SPACING.SINGLE
        changed = True
    if paragraph_format.line_spacing is not None:
        paragraph_format.line_spacing = None
        changed = True
    if paragraph_format.left_indent:
        paragraph_format.left_indent = Pt(0)
        changed = True

    font = style.font
    if font.name != "Arial":
        font.name = "Arial"
        changed = True
    if font.size != Pt(FONT_SIZE_PT):
        font.size = Pt(FONT_SIZE_PT)
        changed = True
    if font.bold:
        font.bold = False
        changed = True
    if font.italic:
        font.italic = False
        changed = True

    return changed


def main() -> int:
    args = parse_args()
    docx_paths = collect_docx_paths(args.paths)
    if not docx_paths:
        print("No DOCX files found to process.", file=sys.stderr)
        return 1

    touched = 0
    had_errors = False

    for doc_path in docx_paths:
        try:
            changed = update_style_in_file(doc_path, args.dry_run)
        except Exception as exc:  # pragma: no cover - runtime safety
            had_errors = True
            print(f"Error processing {doc_path}: {exc}", file=sys.stderr)
            continue

        if changed:
            touched += 1
            status = "[DRY-RUN] " if args.dry_run else ""
            print(f"{status}{doc_path}: updated '{STYLE_NAME}' style")

    print(
        f"Style updates applied to {touched} file(s){' (dry-run)' if args.dry_run else ''}."
    )

    if had_errors:
        print("Completed with errors.", file=sys.stderr)
        return 1 if not touched else 2
    return 0


if __name__ == "__main__":
    sys.exit(main())
